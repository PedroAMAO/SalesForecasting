üìà Forecaster H√≠brido ‚Äî Tend√™ncia + Sazonalidade + ARIMA + ML

Este projeto √© uma aplica√ß√£o em Streamlit para previs√£o de vendas (ou s√©ries temporais similares) usando uma arquitetura h√≠brida:

Modelo Cl√°ssico (Tend√™ncia + Sazonalidade M√©dia em log),

ARIMA aplicado ao ru√≠do da decomposi√ß√£o,

Meta-modelo de Machine Learning (Random Forest) em cima de lags, erros e deltas,

Sele√ß√£o autom√°tica do melhor modelo via Rolling Evaluation por horizonte (H-passo),

Constru√ß√£o de Intervalo de Confian√ßa Din√¢mico por horizonte,

Interpreta√ß√£o autom√°tica via LLM (OpenAI),

Gera√ß√£o de Relat√≥rio Profissional em PDF com gr√°fico, m√©tricas, tabela de previs√£o e an√°lise t√©cnica.

Tudo isso com uma interface simples, clic√°vel e (quase) √† prova de susto.

üöÄ Principais Funcionalidades
üîπ 1. Upload da Base

O app l√™ um arquivo Excel (.xlsx) com as colunas:

ano

m√™s ou mes

Filial

Realizado

Ele √© tolerante com:

Varia√ß√µes de mai√∫sculas/min√∫sculas,

Colunas com nomes pr√≥ximos (ex.: ‚ÄúAno Base‚Äù, ‚ÄúFilial XYZ‚Äù, ‚ÄúRealizado R$‚Äù).

A leitura √© feita via:

safe_sheet_read ‚Üí tenta usar a aba Planilha1, se n√£o existir, pega a primeira,

normalize_columns ‚Üí padroniza nomes, ajusta m√™s/mes, identifica Filial e Realizado.

üîπ 2. Pr√©-processamento Autom√°tico

Ap√≥s o upload, o pipeline:

Converte ano + mes em uma data mensal (YYYY-MM-01),

Cria uma linha agregada de Total (somat√≥rio das filiais),

Calcula a participa√ß√£o da filial (pct_filial) em rela√ß√£o ao total do m√™s,

Ordena a s√©rie temporal,

Cria:

t ‚Üí √≠ndice temporal (0, 1, 2, ...),

mes_num ‚Üí n√∫mero do m√™s (1‚Äì12),

Define a coluna alvo (normalmente Real R$).

Obs.: O app j√° est√° preparado para trabalhar com share (%), mas no c√≥digo atual o modo ativo √© Real R$.

üîπ 3. Modelos de Previs√£o
üìå Modelo Cl√°ssico (Tend√™ncia + Sazonalidade M√©dia)

Implementado na classe ClassicalTrendSeasonalModel, ele trabalha em log:

Log da s√©rie: log(alvo + 1),

Tend√™ncia:

Linear (padr√£o),

Quadr√°tica ou M√©dia (j√° suportadas na arquitetura),

Sazonalidade:

M√©dia mensal dos res√≠duos (um fator por m√™s),

Ru√≠do:

ruido = residuo - sazonalidade,

Estimativa do desvio padr√£o sigma_ruido em log.

Para cada ponto, o modelo retorna:

Previs√£o no n√≠vel,

ic_inf e ic_sup usando 2,57¬∑œÉ em log (‚âà99%),

yhat_log.

üìå ARIMA sobre o Ru√≠do

O ARIMA √© ajustado nos res√≠duos do modelo cl√°ssico:

treinar_arima_ruido(df_treino, order) ajusta um ARIMA em ruido,

Ordem (p, d, q) pode ser:

Definida inicialmente como "0,0,0",

Otimizada automaticamente via otimizar_arima com Rolling-Origin:

Para cada combina√ß√£o de (p, d, q),

Faz forecast one-step ahead do ru√≠do,

Calcula erro m√©dio (MAPE-like ou RMSE),

Escolhe o melhor conjunto.

O app ent√£o:

Reconstr√≥i o ru√≠do em tr√™s blocos:

A: res√≠duos fitted,

B: forecast at√© o fim do hist√≥rico,

C: forecast para meses futuros,

Soma tend√™ncia + sazonalidade + ru√≠do em log,

Volta para o n√≠vel: exp(yhat_log) - 1.

üìå Meta-Modelo de Machine Learning (Random Forest)

Quando o usu√°rio marca ‚Äúü§ñ Ativar previs√£o com Machine Learning (ML)‚Äù, entra o meta-modelo:

Algoritmo: RandomForestRegressor com:

n_estimators = 500

max_depth = None

max_features = "sqrt"

n_jobs = -1

random_state = 42

Features geradas em build_lags:

Lags de:

alvo ‚Üí lag_y_k,

previs√£o Cl√°ssica ‚Üí lag_cl_k,

previs√£o ARIMA ‚Üí lag_ar_k,

Erros defasados:

err_cl_k = lag_y_k - lag_cl_k,

err_ar_k = lag_y_k - lag_ar_k,

Deltas entre lags:

delta_y_k, delta_cl_k, delta_ar_k,

delta_err_cl_k, delta_err_ar_k,

Features contempor√¢neas:

feat_prev_cl_t, feat_prev_ar_t,

feat_t (tempo),

feat_mes_sin, feat_mes_cos (sazonalidade circular).

O treino √© sempre cortado em data_corte para evitar vazamento.

O forecast futuro √© feito via next_step_predict, atualizando recursivamente:

Lags de Y,

Lags de Cl√°ssico/ARIMA,

Erros e deltas,

Tempo e m√™s.

üé® Visualiza√ß√µes

O app gera um Gr√°fico Master com:

Realizado ‚Üí barras cinza,

Cl√°ssico ‚Üí linha preta pontilhada,

ARIMA (Res√≠duos) ‚Üí linha azul,

ML Meta-Model (se ativo) ‚Üí linha roxa,

Linha de corte ‚Üí vertical vermelha,

Ajuste autom√°tico do eixo Y com ‚Äúrespiro‚Äù abaixo do m√≠nimo.

üìò M√©tricas

As m√©tricas s√£o calculadas para:

Per√≠odo Completo:

MAPE (%)

R¬≤

RMSE

P√≥s-corte (apenas datas > data_corte):

Mesmas m√©tricas, para focar na parte que ‚Äúvale‚Äù como previs√£o.

Fun√ß√£o central: metricas(df, col_pred, data_corte).

üîÅ Rolling Evaluation & Melhor Modelo

O app implementa duas camadas de Rolling:

Rolling 1-passo por corte (desligado por padr√£o no bot√£o):

Re-treinando Cl√°ssico / ARIMA / ML a cada corte,

Calculando erro realista (sem olhar o futuro).

Rolling por horizonte (H-passo) para escolha do melhor modelo:

rolling_arima_h e rolling_ml_h rodam os modelos para horizontes h = 1..H,

Calculam erro_pct por horizonte,

Fun√ß√£o resumo_horizonte condensa:

m√©dia do erro,

desvio padr√£o,

banda e_bound(h) = mean + z¬∑std (z = 1,64).

O bot√£o ‚ÄúüèÜ Usar Melhor Modelo (Rolling + IC Din√¢mico)‚Äù:

Compara os modelos (ARIMA e ML) pelo erro m√©dio,

Seleciona o campe√£o,

Gera um intervalo de confian√ßa din√¢mico por horizonte via aplicar_ic_h,

Monta uma tabela de previs√µes futuras (tabela_previsoes) com:

Data,

Horizonte h,

Previs√£o,

IC inferior e superior.

üß¨ Import√¢ncia das Features (Curva ABC)

Quando o ML est√° ativo, o app:

Calcula feature_importances_ da Random Forest,

Traduza os nomes t√©cnicos via traduz_feature (lags, deltas, erros, sazonalidade),

Monta uma Curva ABC:

Percentual de import√¢ncia acumulado,

Classifica√ß√£o em A/B/C,

Exibe as top features e suas contribui√ß√µes.

Tamb√©m gera um gr√°fico horizontal com as Top 15 features e guarda a imagem para uso no PDF.

üß† Relat√≥rio T√©cnico via LLM (OpenAI)

Depois de:

Escolher o melhor modelo,

Gerar o gr√°fico campe√£o com IC,

Construir a tabela de previs√µes,

o app libera a se√ß√£o:

üìò Relat√≥rio T√©cnico ‚Äî Interpreta√ß√£o Acad√™mico-Aplicada

Recursos:

Upload opcional de PDF de contexto organizacional (lido via PyMuPDF),

Gera√ß√£o de um prompt grande com:

Metodologia,

Par√¢metros ARIMA,

M√©tricas dos modelos,

Estrutura do IC din√¢mico,

Import√¢ncia das features do ML (se houver),

Envio da imagem do gr√°fico (base64) + texto para a OpenAI,

Uso do modelo gpt-4o para gerar um relat√≥rio t√©cnico estruturado.

O texto √© exibido no Streamlit e salvo em st.session_state["relatorio_tecnico"].

üí° A chave da OpenAI √© lida de st.secrets["openai_api_key"].

üìÑ Gera√ß√£o de PDF

Com o relat√≥rio pronto, o app permite:

Gerar um PDF completo via reportlab, contendo:

T√≠tulo com nome da filial,

Gr√°fico do melhor modelo,

Gr√°fico de import√¢ncia de features (se existir),

Tabela de m√©tricas,

Tabela com previs√µes futuras (data, horizonte, previs√£o, IC),

Relat√≥rio t√©cnico formatado.

Fun√ß√£o central: gerar_pdf_completo(...).
O download √© feito via st.download_button.
reportlab
pymupdf
openai
python-dateutil
